<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset='utf-8'>
	<meta name='viewport' content='width=device-width,initial-scale=1'>

	<title>shykeiichi</title>

	<link rel='icon' type='image/png' href='./favicon.png'>
	<!-- <link rel='stylesheet' href='./styles_light.css' id="themecss"> -->
    <link rel='stylesheet' href='./global.css'>
    <link rel='stylesheet' href='./board.css'>
</head>
    <body>
        <header>
            <a href="./index.html">shykeiichi</a>
            <div class="headerlinks">
                <a href="./board.html">board</a>
            </div>
            <div style="width: 100%; height: 20px;"></div>
            
            <img src="images/light.svg" alt="theme switcher" id="themebutton"/>
        </header>
        <div class="subheader">
            <a href="./index.html">/</a>
            <a href="./board.html">Board</a>
        </div>
        <div class="main">
            <div>
                <div id="post">
                    <div style="text-align: left">
                        <input id="sendertext" placeholder="Optional Sender"/>
                    </div>
                    <div id="compose">
                        <div>
                            <textarea id="composetextarea" style="margin-bottom: -25px" maxlength="300" placeholder="Content"></textarea>
                        </div>
                        <div>
                            <CButton id="composebutton" on:click="sendData()">Compose</CButton>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container" id="postslist">

            </div>
        </div>
        <footer>
            <a href="https://keii.dev" style="color: rgb(146, 146, 146); width: 120px; position: absolute; left: 20px;">To keii.dev</a>
            <div>
                shykeiichi Â© 2022
            </div>
        </footer>
        <script type="text/javascript" src="./candyland.js"></script>
        <script>
            let theme;
            let start = 0;
            if(localStorage.getItem('theme') == undefined) {
                if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    theme = "dark";
                } else {
                    theme = "light";
                }
            } else {
                theme = localStorage.getItem('theme');
            }
            
            updateTheme();

            document.getElementById('themebutton').addEventListener('click', function (event) {
                if(theme == "light") {
                    theme = "dark";
                } else {
                    theme = "light";
                }
                updateTheme();
            });

            function updateTheme() {
                document.getElementById('themebutton').setAttribute('src', `images/${theme}.svg`)
                if(document.getElementById('themecss') != undefined) {
                    document.getElementById('themecss').remove();
                }
                var cssFile = document.createElement('link');
                cssFile.rel = 'stylesheet';
                cssFile.href = `styles_${theme}.css`;  // or path for file {themes('/styles/mobile.css')}
                cssFile.id = "themecss";
                document.head.appendChild(cssFile); 

                localStorage.setItem('theme', theme);

                setTheme(theme);
            }

            async function sendData() {
                let messageelement = document.getElementById("composetextarea") 
                let senderelement = document.getElementById("sendertext") 
                let messagevalue = document.getElementById("composetextarea").value 
                let sendervalue = document.getElementById("sendertext").value 

                if(messagevalue.length == 0) {
                    messageelement.setAttribute("placeholder", "No text provided")
                    return
                }

                if(sendervalue == "") {
                    sendervalue = null
                }

                const response = await fetch(`https://22widi.ssis.nu/send`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": 'application/json',
                    },
                    body: JSON.stringify({
                        "message": messagevalue,
                        "sender": sendervalue
                    })
                });

                messageelement.value = ""
                senderelement.value = ""

                let doc = document.getElementById("postslist")
                doc.innerHTML = ""

                start = 0
                loadData()
            }

            window.onscroll = function(ev) {
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
                    start += 10;
                    loadData();
                }
            };

            async function loadData() {
                const response = await fetch(`https://22widi.ssis.nu/get?start=${start}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": 'application/json',
                    }
                });
                let json = await response.json();
                console.log(json);

                let doc = document.getElementById("postslist")
                var newhtml = "";
                for(var i = 0; i < Object.keys(json).length; i++) {
                    var date = new Date(parseInt(json[i]["posttime"])*1000);
                    newhtml += "<div id=\"post\">"
                    newhtml += "<div id=\"text\">"
                    newhtml += json[i]["message"]
                    newhtml += "</div>"
                    newhtml += "<div id=\"header\">"
                    newhtml += "<div id=\"user\">"
                    newhtml += json[i]["sender"] == null ? "Anonymous" : json[i]["sender"];
                    newhtml += "</div>"
                    newhtml += "<div id=\"date\">"
                    newhtml += `${date.getHours()}:${date.getMinutes()} ${date.getDate()} ${parseMonth(date.getMonth())} ${date.getFullYear()}`
                    newhtml += "</div>"
                    newhtml += "</div>"
                    newhtml += "</div>"
                }
                console.log(newhtml);
                doc.innerHTML += newhtml;
            }

            function parseMonth(monthnum) {
                switch(monthnum) {
                    case 0:
                        return "Jan"
                    case 1:
                        return "Feb"
                    case 2:
                        return "Mar"
                    case 3:
                        return "Apr"
                    case 4: 
                        return "May"
                    case 5:
                        return "Jun"
                    case 6:
                        return "Jul"
                    case 7:
                        return "Aug"
                    case 8:
                        return "Sep"
                    case 9: 
                        return "Oct"
                    case 10:
                        return "Nov"
                    case 11:
                        return "Dec"
                }
            } 

            loadData();
        </script>
    </body>
</html>